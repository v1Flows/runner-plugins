name: Build and Release

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*.*.*'

jobs:
  list-plugins:
    name: List Plugins
    runs-on: ubuntu-latest
    outputs:
      action-plugins: ${{ steps.list-action.outputs.plugins }}
      endpoint-plugins: ${{ steps.list-endpoint.outputs.plugins }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: List Action Plugins
        id: list-action
        run: |
          PLUGINS=$(find action-plugins -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | jq -R -s -c 'split("\n")[:-1]')
          if [ -z "$PLUGINS" ]; then
            echo "::set-output name=plugins::[]"
          else
            echo "::set-output name=plugins::$PLUGINS"
          fi

      - name: List Endpoint Plugins
        id: list-endpoint
        run: |
          PLUGINS=$(find endpoint-plugins -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | jq -R -s -c 'split("\n")[:-1]')
          if [ -z "$PLUGINS" ]; then
            echo "::set-output name=plugins::[]"
          else
            echo "::set-output name=plugins::$PLUGINS"
          fi

      - name: Debug Plugins
        run: |
          echo "Action Plugins: ${{ steps.list-action.outputs.plugins }}"
          echo "Endpoint Plugins: ${{ steps.list-endpoint.outputs.plugins }}"

  build-and-release-action-plugins:
    name: Build and Release Action Plugins
    needs: list-plugins
    runs-on: ubuntu-latest
    strategy:
      matrix:
        plugin-name: ${{ fromJson(needs.list-plugins.outputs.action-plugins) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Setup Go
        uses: actions/setup-go@v2
        with:
          go-version: '1.24'

      - name: Read Plugin Version
        id: read_version
        working-directory: action-plugins/${{ matrix.plugin-name }}
        run: |
          VERSION=$(cat .version)
          echo "::set-output name=version::$VERSION"

      - name: Build Plugin
        working-directory: action-plugins/${{ matrix.plugin-name }}
        run: go build -o ${{ matrix.plugin-name }}-${{ steps.read_version.outputs.version }}

      - name: Create Release
        id: create_release
        uses: ncipollo/release-action@v1
        with:
          name: Release ${{ matrix.plugin-name }} v${{ steps.read_version.outputs.version }}
          tag: ${{ github.ref_name }}
          artifacts: action-plugins/${{ matrix.plugin-name }}/${{ matrix.plugin-name }}-${{ steps.read_version.outputs.version }}
          skipIfReleaseExists: true
          generateReleaseNotes: true
          token: ${{ secrets.ACCESS_TOKEN }}

  build-and-release-endpoint-plugins:
    name: Build and Release Endpoint Plugins
    needs: list-plugins
    runs-on: ubuntu-latest
    strategy:
      matrix:
        plugin-name: ${{ fromJson(needs.list-plugins.outputs.endpoint-plugins) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Setup Go
        uses: actions/setup-go@v2
        with:
          go-version: '1.24'

      - name: Read Plugin Version
        id: read_version
        working-directory: endpoint-plugins/${{ matrix.plugin-name }}
        run: |
          VERSION=$(cat .version)
          echo "::set-output name=version::$VERSION"

      - name: Build Plugin
        working-directory: endpoint-plugins/${{ matrix.plugin-name }}
        run: go build -o ${{ matrix.plugin-name }}-${{ steps.read_version.outputs.version }}

      - name: Create Release
        id: create_release
        uses: ncipollo/release-action@v1
        with:
          name: Release ${{ matrix.plugin-name }} v${{ steps.read_version.outputs.version }}
          tag: ${{ github.ref_name }}
          artifacts: endpoint-plugins/${{ matrix.plugin-name }}/${{ matrix.plugin-name }}-${{ steps.read_version.outputs.version }}
          skipIfReleaseExists: true
          generateReleaseNotes: true
          token: ${{ secrets.ACCESS_TOKEN }}
